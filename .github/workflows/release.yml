name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create tarball
        run: |
          git archive --format=tar.gz --prefix=nextlnmp-${{ steps.version.outputs.VERSION }}/ -o nextlnmp-${{ steps.version.outputs.VERSION }}.tar.gz ${{ github.ref_name }}

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA=$(sha256sum nextlnmp-${{ steps.version.outputs.VERSION }}.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ SHA256: ${SHA}"

      - name: Update install.sh SHA256 on main branch
        run: |
          git checkout main
          sed -i "s/TARBALL_SHA256=\".*\"/TARBALL_SHA256=\"${{ steps.sha256.outputs.SHA256 }}\"/" install.sh
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add install.sh
          git diff --cached --quiet || git commit -m "chore: fill TARBALL_SHA256 for ${{ github.ref_name }}"
          git push origin main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ github.ref_name }}"
          body: |
            ## âš¡ ä¸€è¡Œå®‰è£…

            ```bash
            bash <(curl -sL https://raw.githubusercontent.com/adsorgcn/nextlnmp/main/install.sh)
            ```

            ## ðŸ“¦ SHA256

            `${{ steps.sha256.outputs.SHA256 }}  nextlnmp-${{ steps.version.outputs.VERSION }}.tar.gz`

            ---

            æ›´æ–°å†…å®¹è¯¦è§ [README æ›´æ–°æ—¥å¿—](https://github.com/adsorgcn/nextlnmp#-%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97)
          files: nextlnmp-${{ steps.version.outputs.VERSION }}.tar.gz
